<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Perfil do Usuário</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
</head>
<body class="bg-zinc-900 text-white min-h-screen flex flex-col items-center p-6">

    <div class="flex flex-col items-center w-full max-w-4xl">
        <img id="profile-image" src="img/user.png" class="w-32 h-32 rounded-full border-4 border-white shadow-lg">
        <h1 id="profile-name" class="text-2xl font-bold mt-4">carregando...</h1>
        <p id="profile-email" class="text-zinc-400">carregando...</p>
        <button id="logout" class="mt-4 bg-red-500 px-6 py-2 rounded-lg hover:bg-red-600 transition">Sair</button>
    </div>

    <h2 class="text-xl font-bold mt-10 mb-4 w-full max-w-4xl">Meus Pedidos</h2>
    <div id="orders-container" class="w-full max-w-4xl flex flex-col gap-4"></div>

<script type="module">
import { getUserOrders } from './hook/buscarUsuario.js';
import { updateOrderStatus } from './hook/cancelarPedido.js';

const token = localStorage.getItem("token");
if (!token) window.location.href = "../login.html";

const profileName = document.getElementById("profile-name");
const profileEmail = document.getElementById("profile-email");
const profileImage = document.getElementById("profile-image");
const ordersContainer = document.getElementById("orders-container");
const logoutBtn = document.getElementById("logout");

logoutBtn.addEventListener("click", () => {
    localStorage.removeItem("token");
    window.location.href = "../index.html";
});

document.addEventListener("DOMContentLoaded", async () => {
    const { profile, orders } = await getUserOrders(token);

    if (profile) {
        profileName.textContent = profile.nome;
        profileEmail.textContent = profile.usuarioEmail;
        if (profile.image) profileImage.src = profile.image;
    } else {
        profileName.textContent = "Usuário";
        profileEmail.textContent = "email@exemplo.com";
    }

    ordersContainer.innerHTML = "";

    if (orders.length > 0) {
        orders.forEach(order => {
            const orderDiv = document.createElement("div");
            orderDiv.className = "bg-zinc-800 p-4 rounded-lg shadow hover:shadow-lg transition";

            const itemsList = order.itens.map(item => 
                `<li>${item.produto} x ${item.quantidade}</li>`
            ).join("");

            const isCancelled = order.status.toLowerCase() === "cancelado";

            orderDiv.innerHTML = `
                <p class="font-bold text-indigo-400 mb-2">Pedido #${order.id.split('-')[0]}</p>
                <ul class="ml-4 list-disc mb-2">${itemsList}</ul>
                <p>Status: <span class="font-semibold text-yellow-400" id="status-${order.id}">${order.status}</span></p>
                <p>Valor total: <span class="font-semibold text-green-400">R$ ${order.valor_total.toFixed(2)}</span></p>
                <p>Pagamento: ${order.forma_pagamento}</p>
                <p>Endereço: ${order.endereco}</p>
                <p class="text-zinc-400 text-sm mt-1">Data: ${new Date(order.dataCriacao).toLocaleDateString()}</p>
                ${!isCancelled ? `<button id="cancel-${order.id}" class="mt-2 bg-red-500 px-4 py-1 rounded hover:bg-red-600 transition">Cancelar Pedido</button>` : ""}
            `;
            ordersContainer.appendChild(orderDiv);

            if (!isCancelled) {
                const cancelBtn = document.getElementById(`cancel-${order.id}`);
                const statusSpan = document.getElementById(`status-${order.id}`);

                cancelBtn.addEventListener("click", async () => {
                    const confirmCancel = confirm("Deseja realmente cancelar este pedido?");
                    if (!confirmCancel) return;

                    const success = await updateOrderStatus(order.id, token);
                    if (success) {
                        statusSpan.textContent = "Cancelado";
                        cancelBtn.remove();
                    }
                });
            }
        });
    } else {
        ordersContainer.innerHTML = "<p class='text-zinc-400'>Você ainda não fez pedidos.</p>";
    }
});
</script>

</body>
</html>
